<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WH-MURTEDE LOGISTICS - V95 TOTAL CONTROL</title>
    
    <!-- SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- EXCEL EXPORT LIBRARY -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root { 
            --primary: #2c3e50; --accent: #3498db; --packing: #28a745; --picking: #8e44ad; --returns: #ff3d00; --error: #e74c3c; --bg: #f4f7f6;
            --color-ctt: #2ecc71; --color-nacex: #9b59b6; --color-correos: #3498db;
            --color-printed: #ff851b; --color-ready: #28a745; --color-packed: #0056b3;
            --color-prepack: #16a085;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f7; margin: 0; color: #333; overflow-x: hidden; font-size: 16px; }
        
        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: var(--primary); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 5000; color: white; }
        .login-card { background: white; padding: 40px; border-radius: 20px; width: 380px; color: #333; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        .login-card input { width: 100%; padding: 15px; margin: 12px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 18px; box-sizing: border-box; }

        /* NAVBAR */
        .nav-bar { background: #fff; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; border-bottom: 3px solid #ddd; position: sticky; top: 0; z-index: 1000; height: 80px; }
        .nav-item { padding: 25px 15px; cursor: pointer; font-weight: 900; color: #7f8c8d; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
        .nav-item.active { color: var(--accent); border-bottom: 5px solid var(--accent); }
        
        .container { max-width: 1800px; margin: 25px auto; padding: 0 25px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 6px 15px rgba(0,0,0,0.08); margin-bottom: 25px; }
        .section { display: none; }
        .section.active { display: block; }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .dash-card { background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-bottom: 5px solid #ddd; }
        .dash-card h2 { font-size: 48px; margin: 0; color: var(--primary); }
        .dash-card p { margin: 10px 0 0; font-weight: 900; text-transform: uppercase; font-size: 14px; color: #7f8c8d; }

        /* KANBAN OVERVIEW */
        .mgmt-wrapper { display: flex; gap: 30px; overflow-x: auto; padding-bottom: 30px; align-items: flex-start; }
        .carrier-column { min-width: 380px; max-width: 380px; flex-shrink: 0; background: rgba(0,0,0,0.03); border-radius: 20px; padding: 15px; }
        .carrier-header { border-radius: 12px; color: white; padding: 15px; font-weight: 900; font-size: 18px; text-align: center; margin-bottom: 15px; text-transform: uppercase; }
        .batch-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .progress-container { background: #eee; border-radius: 10px; height: 8px; margin: 12px 0; overflow: hidden; }
        .progress-bar { background: var(--packing); height: 100%; transition: width 0.5s; }

        /* BUTTONS */
        .btn-mobile-op { width: 100%; padding: 20px; font-size: 18px; font-weight: 900; border: none; border-radius: 12px; cursor: pointer; color: white; text-transform: uppercase; transition: 0.2s; margin-bottom: 10px; }
        .btn-op-green { background: var(--packing); }
        .btn-op-purple { background: var(--picking); }
        .btn-op-orange { background: var(--returns); }
        .btn-submit { background: var(--packing); color: white; width: 100%; font-size: 18px; padding: 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .btn-small { padding: 8px 12px; font-size: 11px; border-radius: 6px; border: none; cursor: pointer; color: white; font-weight: bold; text-transform: uppercase; }
        .btn-delete { background: var(--error) !important; }
        .btn-dismiss { background: #fff; color: var(--error); border: 2px solid var(--error); padding: 10px 20px; border-radius: 8px; font-weight: 900; cursor: pointer; margin-top: 10px; font-size: 16px; }

        /* MODALS */
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:6000; justify-content:center; align-items:center; backdrop-filter: blur(5px); }
        .modal-content { background:white; padding:40px; border-radius:25px; width:95%; max-width:1500px; max-height:90vh; overflow-y:auto; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .scroll-area { max-height: 450px; overflow-y: auto; border: 1px solid #ddd; border-radius: 12px; background: #fff; margin-top: 10px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        table th { background: #f1f3f5; position: sticky; top: 0; z-index: 10; padding: 12px; border-bottom: 2px solid #dee2e6; text-align: left; }
        table td { padding: 12px; border-bottom: 1px solid #eee; }

        .prod-tag { background: #eee; padding: 8px 12px; border-radius: 6px; margin: 4px; font-size: 14px; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; border: 1px solid #ccc; }
        .meta-cancel-banner { background: #e74c3c; color: white; padding: 20px; border-radius: 12px; font-weight: 900; text-align: center; margin-bottom: 20px; font-size: 28px; animation: blink 1s infinite; display: flex; flex-direction: column; align-items: center; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .grid-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; }
        @media(max-width: 900px){ .grid-3{ grid-template-columns: 1fr; } }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        input, textarea, select { width: 100%; padding: 15px; margin: 8px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        .location-tag { background: #fee2e2; color: #991b1b; padding: 5px 12px; border-radius: 8px; font-weight: 900; font-size: 20px; margin-left: auto; border: 1px solid #f87171; }
    
        /* ‚úÖ CANCELLED IDs (red strike) */
        .cancelled-id {
          color: var(--error);
          font-weight: 900;
          text-decoration: line-through;
          text-decoration-color: var(--error);
          text-decoration-thickness: 3px;
        }
        .cancelled-row {
          background: #fff5f5;
        }

    </style>
</head>
<body>

<div id="login-screen">
    <h1>WH-MURTEDE</h1>
    <div class="login-card">
        <input type="email" id="login-email" placeholder="Email (@admin.com / @wh.com)">
        <input type="password" id="login-pass" placeholder="Password">
        <button style="width:100%; background:var(--accent); color:white; border:none; padding:20px; border-radius:12px; cursor:pointer; font-weight:bold; font-size:20px;" onclick="handleLogin()">SIGN IN</button>
    </div>
</div>

<!-- MODAL: DETALHES DO LOTE -->
<div id="edit-batch-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="edit-batch-title" style="font-size:30px; margin:0;">Batch Details</h2>
            <button class="btn-small btn-delete" id="modal-delete-btn" style="padding:15px 30px; font-size:16px;">DELETE ENTIRE BATCH</button>
        </div>
        <div id="edit-batch-meta" style="margin-top:10px; font-size:14px; color:#444;"></div>
        <hr style="margin:25px 0;">
        <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:30px;">
            <div>
                <h4>üì¶ Inventory Status</h4>
                <div class="scroll-area">
                    <table id="edit-inventory-table">
                        <thead><tr id="inv-header"><th>Product</th><th>Qty</th><th>Pos</th><th class="admin-only-cell">Del</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <h4>üìä Modification Log</h4>
                <div id="qty-modification-log" style="font-size:11px; background:#f8f9fa; padding:10px; border-radius:10px; height:200px; overflow-y:auto; border:1px solid #ddd; font-family: monospace;"></div>
            </div>
            <div>
                <h4>üÜî Order Mapping & Full Tracking</h4>
                <div class="scroll-area" id="edit-ids-list"></div>
                <h4 style="margin-top:20px; color: var(--error);">üö´ Cancellation Reasons Log</h4>
                <div id="cancelled-ids-log" style="font-size:11px; background:#fff5f5; padding:10px; border-radius:10px; height:150px; overflow-y:auto; border:1px solid #fab1a0; font-family: monospace;"></div>
            </div>
        </div>
        <button class="btn-submit" style="margin-top:35px; background: var(--primary);" onclick="closeModal('edit-batch-modal')">CLOSE WINDOW</button>
    </div>
</div>

<!-- MODAL: ID HISTORY -->
<div id="id-history-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:15px;">
            <h2 id="id-history-title" style="font-size:30px; margin:0;">ID History</h2>
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="btn-small" style="background: var(--accent); padding: 14px 18px; font-size: 14px;" onclick="exportIdHistory()">EXPORT THIS ID</button>
                <button class="btn-small btn-delete" style="padding: 14px 18px; font-size: 14px;" onclick="closeModal('id-history-modal')">CLOSE</button>
            </div>
        </div>
        <hr style="margin:20px 0;">
        
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 10px;">
            <div style="min-width:180px; flex:1;">
                <label style="font-weight:900; font-size:12px; color:#666;">Start</label>
                <input type="date" id="modal-start-date">
            </div>
            <div style="min-width:180px; flex:1;">
                <label style="font-weight:900; font-size:12px; color:#666;">End</label>
                <input type="date" id="modal-end-date">
            </div>
            <div style="min-width:220px; flex:1;">
                <label style="font-weight:900; font-size:12px; color:#666;">Type</label>
                <select id="modal-type-filter">
                    <option value="ALL">ALL</option>
                    <option value="OFFICE / BATCH_CREATED">OFFICE / BATCH_CREATED</option>
                    <option value="CANCELLED">CANCELLED</option>
                    <option value="PACKING">PACKING</option>
                    <option value="RETURNS">RETURNS</option>
                </select>
            </div>
            <div style="min-width:220px; flex:1;">
                <label style="font-weight:900; font-size:12px; color:#666;">Status</label>
                <select id="modal-status-filter">
                    <option value="ALL">ALL</option>
                    <option value="PACKED">PACKED</option>
                    <option value="PENDING">PENDING</option>
                    <option value="CANCELLED">CANCELLED</option>
                </select>
            </div>
            <div style="display:flex; align-items:flex-end;">
                <button class="btn-small" style="background: var(--primary); padding: 14px 18px; font-size: 14px;" onclick="applyIdHistoryFilters()">APPLY</button>
            </div>
        </div>

        <div id="id-history-timeline" style="margin-top: 10px; padding: 10px 5px;"></div>

        <div id="id-history-summary" style="background:#f8f9fa; border:1px solid #ddd; padding:15px; border-radius:12px; font-size:14px;"></div>
        <div class="scroll-area" style="margin-top: 15px;">
            <table id="id-history-table">
                <thead>
                    <tr>
                        <th>Date/Time</th>
                        <th>Type</th>
                        <th>Batch</th>
                        <th>Carrier</th>
                        <th>User</th>
                        <th>Tracking</th>
                        <th>Items / Content</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="main-interface" style="display:none;">
    <div class="nav-bar">
        <div id="menu-items" style="display:flex;"></div>
        <button onclick="logout()" style="color:var(--error); border:none; background:none; cursor:pointer; font-weight:900; font-size:14px;">LOGOUT</button>
    </div>

    <div class="container">
        
        <!-- SECTION: OVERVIEW -->
        <div id="sec-overview" class="section">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0;">üåç Warehouse Overview</h2>
                <input type="date" id="global-date-filter" onchange="syncGlobalData()" style="width:220px;">
            </div>
            <div class="dashboard-grid">
                <div class="dash-card"> <h2 id="card-printed">0</h2> <p>Total Printed</p> </div>
                <div class="dash-card"> <h2 id="card-ready">0</h2> <p>Pending Packing</p> </div>
                <div class="dash-card"> <h2 id="card-packed">0</h2> <p>Packed Today</p> </div>
                <div class="dash-card"> <h2 id="card-prepack">0</h2> <p>Pre-Packed Today</p> </div>
            </div>
            <div id="mgmt-container" class="mgmt-wrapper"></div>
        </div>

        <!-- SECTION: SEARCH (ID HISTORY) -->
        <div id="sec-search" class="section">
            <div class="card">
                <h2>üîç Deep Order Search</h2>
                <p>Paste Order IDs to see full history grouped by ID.</p>
                <textarea id="search-ids-input" rows="4" placeholder="12345678, 87654321"></textarea>
                <div class="grid-2" style="margin-top: 10px;">
                    <div>
                        <label style="font-weight:900; font-size:12px; color:#666;">Start Date</label>
                        <input type="date" id="search-start-date">
                    </div>
                    <div>
                        <label style="font-weight:900; font-size:12px; color:#666;">End Date</label>
                        <input type="date" id="search-end-date">
                    </div>
                </div>
                <div style="margin-top:10px; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="search-all-records" style="width:22px; height:22px;">
                    <label for="search-all-records" style="font-weight:900; font-size:14px; color:#333;">SEARCH ALL RECORDS (slow)</label>
                    <span style="font-size:12px; color:#666;">Use when you don't know the date.</span>
                </div>
                <div class="grid-2" style="margin-top: 10px;">
                    <div>
                        <label style="font-weight:900; font-size:12px; color:#666;">Event Type</label>
                        <select id="search-type-filter">
                            <option value="ALL">ALL</option>
                            <option value="OFFICE / BATCH_CREATED">OFFICE / BATCH_CREATED</option>
                            <option value="CANCELLED">CANCELLED</option>
                            <option value="PACKING">PACKING</option>
                            <option value="RETURNS">RETURNS</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight:900; font-size:12px; color:#666;">Status</label>
                        <select id="search-status-filter">
                            <option value="ALL">ALL</option>
                            <option value="PACKED">PACKED</option>
                            <option value="PENDING">PENDING</option>
                            <option value="CANCELLED">CANCELLED</option>
                            <option value="NOT FOUND">NOT FOUND</option>
                        </select>
                    </div>
                </div>

                <button class="btn-submit" style="background: var(--accent); margin-top: 10px;" onclick="searchOrderHistory()">SEARCH HISTORY</button>
                <button class="btn-submit" style="background: var(--packing); margin-top: 10px;" onclick="exportAllSearchHistories()">EXPORT ALL (EXCEL)</button>

                <div id="search-cards-container" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 15px;"></div>
</div>
            </div>
        </div>

        <!-- SECTION: PERFORMANCE -->
        <div id="sec-performance" class="section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2 style="margin:0;">üìä Operator Performance</h2>
                    <input type="date" id="perf-date-filter" onchange="loadPerformanceStats()" style="width:220px;">
                </div>
                <div class="scroll-area"><table id="perf-table"><thead><tr><th>Operator</th><th>Packed</th><th>Returns</th><th>Pre-Packs</th><th>Total</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <!-- SECTION: REPORTS (EXCEL EXPORT) -->
        <div id="sec-reports" class="section">
            <div class="card">
                <h2>üìÅ Excel Reports & Exports</h2>
                <div class="grid-2">
                    <div>
                        <h4>1. Export by Date Range</h4>
                        <label>Start Date:</label><input type="date" id="rep-start-date">
                        <label>End Date:</label><input type="date" id="rep-end-date">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <button class="btn-mobile-op btn-op-green" onclick="exportData('ACTIVITY')">Packing/Returns</button>
                            <button class="btn-mobile-op btn-op-green" style="background:var(--color-prepack);" onclick="exportData('PREPACK')">Pre-Packing</button>
                        </div>
                    </div>
                    <div>
                        <h4>2. Transport Carrier Report</h4>
                        <p>Export ID | Carrier | Timestamps list.</p>
                        <button class="btn-mobile-op btn-op-purple" style="width:100%;" onclick="exportData('CARRIERS')">Group by Carrier</button>
                        <small>* Start/End/Confirmed times included.</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: PICKING -->
        <div id="sec-picking" class="section">
            <div class="card">
                <h2>üß∫ Picking Phase</h2>

                <div style="display:flex; justify-content:flex-end; align-items:center; gap:12px; margin-top:10px;">
                    <div style="font-weight:900; font-size:12px; color:#666; text-transform:uppercase;">Data</div>
                    <input type="date" id="pick-date-filter" style="width:220px;" onchange="setPickingDate(this.value)">
                </div>

                <div class="grid-3" style="margin-top:12px;">
                    <div class="card" style="margin:0; padding:14px;">
                        <div style="font-size:12px; color:#666; font-weight:900;">Lotes por recolher</div>
                        <div id="pick-card-batches" style="font-size:30px; font-weight:1000; margin-top:6px;">0</div>
                    </div>
                    <div class="card" style="margin:0; padding:14px;">
                        <div style="font-size:12px; color:#666; font-weight:900;">IDs por recolher</div>
                        <div id="pick-card-ids" style="font-size:30px; font-weight:1000; margin-top:6px;">0</div>
                    </div>
                    <div class="card" style="margin:0; padding:14px;">
                        <div style="font-size:12px; color:#666; font-weight:900;">Produtos por recolher</div>
                        <div id="pick-card-products" style="font-size:30px; font-weight:1000; margin-top:6px;">0</div>
                    </div>
                </div>

                <div style="display:flex; gap:15px;">
                    <select id="pick-batch-select" onchange="loadPickingList()" style="flex:1; height:65px; font-size:22px; font-weight:bold;"></select>
                    <button id="btn-pick-details" class="btn-submit" style="width:200px; background:var(--primary); display:none;" onclick="openEditModal(document.getElementById('pick-batch-select').value, true)">VIEW DETAILS</button>
                    <button id="btn-select-all" class="btn-submit" style="width:200px; background:var(--accent); display:none;" onclick="selectAllPicking()">SELECT ALL</button>
                </div>
                <div id="picking-list-container" style="margin-top:25px;"></div>
                <button id="btn-finish-picking" class="btn-submit" style="background:var(--picking); display:none; margin-top:35px; height:80px; font-size:24px;" onclick="finishPicking()">PICKING COMPLETE -> MOVE TO PACKING</button>
            </div>
        </div>

        <!-- SECTION: PACKING -->
        <div id="sec-warehouse" class="section">
            <div class="grid-2">
                <div class="card">
                    <h3>1. Select Active Batch</h3>
                    
                    <div style="display:flex; justify-content:flex-end; align-items:center; gap:12px; margin-top:10px;">
                        <div style="font-weight:900; font-size:12px; color:#666; text-transform:uppercase;">Data</div>
                        <input type="date" id="pack-date-filter" style="width:220px;" onchange="setPackingDate(this.value)">
                    </div>

                    <select id="wh-batch-select" onchange="loadBatchData(this.value)" style="height:70px; font-weight:bold; font-size:22px; border: 3px solid var(--primary);"></select>
                </div>
                <div class="card">
                    <div id="meta-cancel-banner" class="meta-cancel-banner" style="display:none;">
                        <span>ORDER CANCELED!</span>
                        <button class="btn-dismiss" onclick="resetScan()">CLEAR SCAN</button>
                    </div>
                    <p style="font-size:20px;">ID: <b id="v-id">-</b> | Track: <b id="v-track">-</b></p>
                    <div id="packing-info-display" style="display:none; border:2px solid #ddd; padding:15px; border-radius:10px; background:#fcfcfc;">
                        <div style="font-size:10px; font-weight:bold; color:#777;">CUSTOMER:</div> <div id="meta-cust-name" style="font-size:20px; font-weight:bold;">-</div>
                        <div style="font-size:10px; font-weight:bold; color:#777;">EXPECTED CONTENT:</div> <div id="meta-inv-content" style="font-size:20px; font-weight:bold; color:var(--accent);">-</div>
                    </div>
                    <div id="v-prods" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;"></div>
                </div>
            </div>
            <div class="card scan-area" style="text-align:center;">
                <input type="text" id="main-input" placeholder="SCAN BARCODE..." style="font-size:45px; text-align:center; height:100px; border: 4px solid var(--accent); border-radius:15px;" autocomplete="off">
                <button id="btn-confirm-order" class="btn-mobile-op btn-op-green" style="display:none;" onclick="confirmOrder('PACKING')">ID COMPLETE</button>
            </div>
            <div class="card">
                <h3>üì¶ IDs Picados neste Lote (Conclu√≠dos)</h3>
                <div class="scroll-area">
                    <table id="recent-scans-table">
                        <thead><tr><th>Hora</th><th>ID Pedido</th><th>Cliente</th><th>A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button id="btn-finalize-batch" class="btn-mobile-op btn-op-purple" style="display:none; margin-top:20px;" onclick="finishBatchPacking()">FINALIZE BATCH</button>
            </div>
        </div>

        <!-- SECTION: RETURNS -->
        <div id="sec-returns" class="section">
            <div class="card scan-area" style="text-align:center;">
                <h2>üîÑ RETURNS SCANNER</h2>
                <input type="text" id="return-input" placeholder="SCAN ID, TRACK OR PRODUCT..." style="font-size:45px; text-align:center; height:100px; border: 4px solid var(--returns); border-radius:15px;" autocomplete="off" onkeypress="if(event.key==='Enter'){handleScan(this.value, 'RETURN'); this.value='';}">
            </div>
            <div class="card">
                <p style="font-size:22px;">ID: <b id="rv-id">-</b> | Track: <b id="rv-track">-</b></p>
                <div id="rv-prods" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;"></div>
                <button class="btn-mobile-op btn-op-orange" onclick="confirmOrder('RETURN')">SAVE RETURN</button>
            </div>
            <div class="card">
                <h3>Recent Returns</h3>
                <div class="scroll-area"><table id="recent-returns-table"><thead><tr><th>Time</th><th>User</th><th>ID</th><th>Items</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <!-- OTHERS -->
        <div id="sec-prepack" class="section">
            <div class="card" style="text-align:center;"><h2>üì¶ PRE-PACKING</h2><input type="text" id="prepack-input" placeholder="SCAN..." style="font-size:45px; text-align:center; height:100px; border: 4px solid var(--color-prepack); border-radius:15px;" onkeypress="if(event.key==='Enter'){handlePrePack(this.value); this.value='';}"></div>
            <div class="card"><h3>Today's Pre-Packings</h3><div class="scroll-area"><table id="prepack-recent-table"><thead><tr><th>Time</th><th>User</th><th>Product</th><th>Action</th></tr></thead><tbody></tbody></table></div></div>
        </div>
        <div id="sec-masterdata" class="section">
            <div class="card"><h2>üìã Master Product Database</h2><div class="grid-2"><input type="file" id="csv-file-input" accept=".csv"><button class="btn-submit" onclick="handleCSVUpload()">UPLOAD CSV</button></div><hr><input type="text" id="master-search" placeholder="Search..." onkeyup="updateMasterPreview()"><div class="scroll-area"><table id="master-db-table"><thead><tr><th>Barcode</th><th>Product Name</th></tr></thead><tbody></tbody></table></div></div>
        </div>
        <div id="sec-office" class="section">
            <div class="card"><h2>üì¶ Create New Batch</h2><div class="grid-2"><input type="text" id="off-batch-name" placeholder="Name"><select id="off-carrier-select"></select></div><input type="date" id="off-batch-date"><div class="grid-2"><textarea id="off-products-list" rows="12" placeholder="SKU [TAB] Qty [TAB] Pos"></textarea><textarea id="off-order-meta" rows="12" placeholder="ID [TAB] Customer [TAB] Content"></textarea></div><button class="btn-submit" onclick="createBatch()">CREATE BATCH</button></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDExvgmtrSILCATQgE8ICJX-SVntb5lM2Y",
        authDomain: "wh-murtede.firebaseapp.com",
        databaseURL: "https://wh-murtede-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "wh-murtede",
        storageBucket: "wh-murtede.firebasestorage.app",
        messagingSenderId: "415946575714",
        appId: "1:415946575714:web:b1516b91b9735b9248e63b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.database();

    // scanData now includes startTime and endTime
    let currentUser = null, scanData = { id: "", track: "", prods: [], startTime: "", endTime: "" };
    let isAdminUser = false;
    let masterProductsDB = {}, currentMode = "PACKING", activeBatchData = null, activeBatchPath = null;

    // --- PERF: shared listener state (avoid duplicated .on listeners) ---
    let __cfgBound = false;
    let __overviewBatchesRef = null, __overviewBatchesCb = null;
    let __overviewPrepackRef = null, __overviewPrepackCb = null;
    let __overviewCacheBatches = {};
    let __overviewCachePrepackCount = 0;

    let __prepackTodayRef = null, __prepackTodayCb = null;
    let __returnsTodayRef = null, __returnsTodayCb = null;

    let __processedRegRef = null, __processedRegCb = null;

    let __modalBatchRef = null, __modalBatchCb = null;


    function safeKey(str) { if(!str) return "UNKNOWN"; return str.toString().replace(/[.#$/[\]]/g, "_").trim().toUpperCase(); }

    

    // Returns expected IDs excluding cancelled IDs
    function getRequiredBatchIds(batch) {
        const expected = (batch && batch.expected_ids) ? batch.expected_ids : [];
        const cancelled = (batch && batch.cancelled_ids) ? Object.keys(batch.cancelled_ids) : [];
        const cancelledSet = new Set(cancelled);
        return expected.filter(id => !cancelledSet.has(id));
    }

document.addEventListener('click', (e) => {
        const inp = document.getElementById('main-input');
        if (inp && !['INPUT','TEXTAREA','SELECT','OPTION','BUTTON'].includes(e.target.tagName) && !e.target.closest('.modal-content')) { inp.focus(); }
    });

    window.onload = () => { 
        const today = new Date().toISOString().split('T')[0];
        document.querySelectorAll('input[type="date"]').forEach(i => i.value = today);
    
        try {
            var todayObj = new Date();
            var end = todayObj.toISOString().split('T')[0];
            var startObj = new Date(todayObj.getTime() - (7 * 24 * 60 * 60 * 1000));
            var start = startObj.toISOString().split('T')[0];
            var sEl = document.getElementById('search-start-date');
            var eEl = document.getElementById('search-end-date');
            if (sEl) sEl.value = start;
            if (eEl) eEl.value = end;
        } catch(e) {}
};

    auth.onAuthStateChanged(user => {
        if (user) { currentUser = user; setupUI(user.email); } 
        else { document.getElementById('login-screen').style.display = 'flex'; document.getElementById('main-interface').style.display = 'none'; }
    });

    async function handleLogin() {
        const e = document.getElementById('login-email').value, p = document.getElementById('login-pass').value;
        try { await auth.signInWithEmailAndPassword(e, p); } catch(e) { alert("Invalid credentials."); }
    }

    function setupUI(email) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-interface').style.display = 'block';
        const isAdmin = email.endsWith('@admin.com');
        isAdminUser = isAdmin;
        const m = document.getElementById('menu-items');
        
        m.innerHTML = isAdmin ? 
            `<div class="nav-item" onclick="tab('sec-overview', this)">OVERVIEW</div>
             <div class="nav-item" onclick="tab('sec-search', this)">SEARCH</div>
             <div class="nav-item" onclick="tab('sec-performance', this)">PERFORMANCE</div>
             <div class="nav-item" onclick="tab('sec-reports', this)">REPORTS</div>
             <div class="nav-item" onclick="tab('sec-prepack', this)">PRE-PACKING</div>
             <div class="nav-item" onclick="tab('sec-masterdata', this)">MASTER DATA</div>
             <div class="nav-item" onclick="tab('sec-office', this)">OFFICE</div>
             <div class="nav-item" onclick="tab('sec-picking', this)">PICKING</div>
             <div class="nav-item" onclick="tab('sec-warehouse', this)">PACKING</div>
             <div class="nav-item" onclick="tab('sec-returns', this)">RETURNS</div>` :
            `<div class="nav-item" onclick="tab('sec-picking', this)">PICKING</div>
             <div class="nav-item" onclick="tab('sec-prepack', this)">PRE-PACKING</div>
             <div class="nav-item" onclick="tab('sec-returns', this)">RETURNS</div>
             <div class="nav-item" onclick="tab('sec-warehouse', this)">PACKING</div>`;
        
        syncGlobalData();
        if(isAdmin) tab('sec-overview', document.querySelector('[onclick*="sec-overview"]'));
        else tab('sec-picking', document.querySelector('[onclick*="sec-picking"]'));
    }

    function tab(id, el) {
        // --- ACCESS GUARD (WH users only see Picking, Pre-Packing, Returns, Packing) ---
        if(!isAdminUser) {
            const allowed = ['sec-picking','sec-prepack','sec-returns','sec-warehouse'];
            if(!allowed.includes(id)) {
                id = 'sec-picking';
                el = document.querySelector('[onclick*="sec-picking"]');
            }
        }

        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(el) el.classList.add('active');

        // keep PICKING date selector in sync with the global date filter
        if(id === 'sec-picking') {
            try {
                const gd = document.getElementById('global-date-filter');
                const pk = document.getElementById('pick-date-filter');
                if(gd && pk && gd.value && pk.value !== gd.value) pk.value = gd.value;
            } catch(e) {}
        }
        
        if(id === 'sec-warehouse') {
            // keep PACKING date selector in sync with the global date filter
            try {
                const gd = document.getElementById('global-date-filter');
                const pa = document.getElementById('pack-date-filter');
                if(gd && pa && gd.value && pa.value !== gd.value) pa.value = gd.value;
            } catch(e) {}

            const saved = localStorage.getItem('lastPackingBatch');
            if(saved) { setTimeout(() => { const sel = document.getElementById('wh-batch-select'); if(sel && sel.querySelector(`option[value="${saved}"]`)) { sel.value = saved; loadBatchData(saved); } }, 300); }
        }
        
        resetScan();
        if(id === 'sec-prepack') loadPrePackHistory();
        if(id === 'sec-returns') loadRecentReturns();
    }

    function logout() { auth.signOut(); localStorage.removeItem('lastPackingBatch'); }

    // --- NEW: EXCEL EXPORT LOGIC WITH START/END TIMES ---
    async function exportData(type) {
        const start = document.getElementById('rep-start-date').value;
        const end = document.getElementById('rep-end-date').value;
        const dataToExport = [];

        // Helper: check YYYY-MM-DD in range (inclusive)
        const inRange = (d) => (d && d >= start && d <= end);

        if (type === 'ACTIVITY') {
            const snap = await db.ref('registos').once('value');
            const batchSnap = await db.ref('active_batches').once('value');
            const batches = batchSnap.val() || {};

            Object.values(snap.val() || {}).forEach(r => {
                if (inRange(r.dateClean)) {
                    const carrier = (batches[r.batch] && batches[r.batch].carrier) ? batches[r.batch].carrier : "N/A";
                    dataToExport.push({
                        Date: r.dateClean,
                        Start_Time: r.startTime || r.time,
                        End_Time: r.endTime || r.time,
                        ID: r.id,
                        Mode: r.mode,
                        User: r.user,
                        Tracking: r.track,
                        Items: r.prods,
                        Carrier: carrier,
                        Batch_Key: r.batch || "GENERAL",
                        Batch_Name: (batches[r.batch] && batches[r.batch].name) ? batches[r.batch].name : "GENERAL"
                    });
                }
            });

        } else if (type === 'CARRIERS') {
            // CARRIERS: export ALL IDs created in batches in the date range,
            // including batch info, who packed, tracking, contents, status + cancellation reason.
            const [batchSnap, regSnap] = await Promise.all([
                db.ref('active_batches').once('value'),
                db.ref('registos').once('value')
            ]);

            const batches = batchSnap.val() || {};
            const registos = regSnap.val() || {};

            // Build quick lookup for packing records: batchKey -> id -> latest packing record
            const packIndex = {};
            Object.values(registos).forEach(r => {
                if (r && r.mode === 'PACKING' && r.batch && r.id) {
                    if (!packIndex[r.batch]) packIndex[r.batch] = {};
                    const prev = packIndex[r.batch][r.id];
                    // pick the latest by (dateClean + time) string if possible; else keep first
                    const curKey = (r.dateClean || "") + " " + (r.endTime || r.time || "");
                    const prevKey = prev ? ((prev.dateClean || "") + " " + (prev.endTime || prev.time || "")) : "";
                    if (!prev || curKey > prevKey) packIndex[r.batch][r.id] = r;
                }
            });

            Object.entries(batches).forEach(([batchKey, b]) => {
                if (!b || !inRange(b.dateClean)) return;

                const batchName = b.name || batchKey;
                const carrier = b.carrier || "N/A";
                const expected = b.expected_ids || [];
                const orderDetails = b.order_details || {};
                const cancelled = b.cancelled_ids || {};

                expected.forEach(orderId => {
                    const det = orderDetails[orderId] || {};
                    const cancelInfo = cancelled[orderId] || null;
                    const packRec = (packIndex[batchKey] && packIndex[batchKey][orderId]) ? packIndex[batchKey][orderId] : null;

                    // Status precedence: CANCELLED > PACKED > PENDING
                    let status = "PENDING";
                    if (cancelInfo) status = "CANCELLED";
                    else if (packRec) status = "PACKED";

                    dataToExport.push({
                        Batch_Key: batchKey,
                        Batch_Name: batchName,
                        Carrier: carrier,
                        Batch_Date: b.dateClean || "",
                        Order_ID: orderId,
                        Customer: det.name || "",
                        Expected_Content: det.content || "",
                        Status: status,
                        Cancel_Reason: cancelInfo ? (cancelInfo.reason || "") : "",
                        Cancelled_By: cancelInfo ? (cancelInfo.user || "") : "",
                        Cancelled_At: cancelInfo ? (_normalizeDT(cancelInfo.DateTime || (cancelInfo.dateClean && cancelInfo.time ? _dtKey(cancelInfo.dateClean, cancelInfo.time) : cancelInfo.time), (b.dateClean || "")) || "") : "",
                        Packed_By: packRec ? (packRec.user || "") : "",
                        Packed_Date: packRec ? (packRec.dateClean || "") : "",
                        Packed_Start_Time: packRec ? (packRec.startTime || "") : "",
                        Packed_Confirmed_Time: packRec ? (packRec.endTime || packRec.time || "") : "",
                        Tracking: packRec ? (packRec.track || "") : "",
                        Packed_Items: packRec ? (packRec.prods || "") : ""
                    });
                });
            });

        } else if (type === 'PREPACK') {
            const snap = await db.ref('pre_packing').once('value');
            Object.values(snap.val() || {}).forEach(p => {
                if (inRange(p.dateClean)) {
                    dataToExport.push({ Date: p.dateClean, Time: p.time, User: p.user, Product: p.product });
                }
            });
        }

        if (dataToExport.length === 0) return alert("No data found for these dates.");
        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Report");
        XLSX.writeFile(wb, `WH_Export_${type}_${start}_to_${end}.xlsx`);
    }
function handleScan(v, mode) {
        const m = mode || currentMode;
        const key = safeKey(v);
        if(masterProductsDB[key]) {
            const prodName = masterProductsDB[key]; scanData.prods.push(prodName);
        } else if(/^\d{8}$/.test(v)) {
            // RECORD START TIME ON FIRST SCAN OF ID
            if(!scanData.id) scanData.startTime = _nowTime();
            scanData.id = v; if(m === 'PACKING') showMetadata(v); 
        } else {
            scanData.track = v;
        }
        updateDisplay(m);
        if(scanData.id && scanData.track) document.getElementById('btn-confirm-order').style.display = 'block';
    }
    async function confirmOrder(mode) {
        const m = mode || currentMode;
        const bId = document.getElementById('wh-batch-select').value;
        if(!scanData.id || !scanData.track) return alert("Faltam dados!");

        // Work day: the real day the operator is performing the action
        const workDc = _nowDateClean();
        const endTime = _nowTime();

        // Business day: the day of the batch (shipping day) for PACKING
        let dc = workDc;

        try {
            if(m === 'PACKING' && bId) {
                // Make sure PACKING records are stored under the batch date (shipping day)
                let batchDc = (activeBatchData && activeBatchData.dateClean) ||
                              (__overviewCacheBatches && __overviewCacheBatches[bId] && __overviewCacheBatches[bId].dateClean) ||
                              '';

                if(!batchDc) {
                    const dSnap = await db.ref(`active_batches/${bId}/dateClean`).once('value');
                    batchDc = dSnap.val() || '';
                }
                if(batchDc) dc = batchDc;

                await db.ref(`active_batches/${bId}/processed_ids/${scanData.id}`).set(true);
                logBatchAction(bId, `PACKED ID: ${scanData.id}`);
            }

            await db.ref('registos').push({
                id: scanData.id,
                track: scanData.track,
                prods: scanData.prods.join(' | ') || 'No Items',
                mode: m,
                batch: bId || 'GENERAL',
                user: currentUser.email.split('@')[0].toUpperCase(),
                startTime: scanData.startTime || endTime,
                endTime: endTime,
                time: endTime, // Main sorting time

                // Date used for totals / exports (shipping day in PACKING)
                dateClean: dc,
                DateTime: _dtKey(dc, endTime),

                // Optional: keep the real work day for productivity analytics
                workDateClean: workDc,
                workDateTime: _dtKey(workDc, endTime),

                ts: Date.now()
            });

            resetScan();
        } catch (e) {
            alert('Erro ao gravar.');
        }
    }

    function resetScan() {
        scanData = {id:"", track:"", prods:[], startTime: "", endTime: ""}; 
        const labels = ['v-id', 'v-track', 'meta-cust-name', 'meta-inv-content', 'rv-id', 'rv-track'];
        labels.forEach(id => { const el = document.getElementById(id); if(el) el.innerText = "-"; });
        const containers = ['v-prods', 'rv-prods'];
        containers.forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = ""; });
        document.getElementById('packing-info-display').style.display = 'none'; 
        document.getElementById('meta-cancel-banner').style.display = 'none'; 
        document.getElementById('btn-confirm-order').style.display = 'none'; 
        const inp = document.getElementById('main-input'); if(inp) { inp.value = ""; inp.focus(); }
    }

    // --- OTHER LOGICS ---
    // --- SEARCH: CARDS PER ID + MODAL FULL HISTORY + EXPORT (PERFORMANCE + FILTERS + TIMELINE) ---
    var searchCache = { ids: [], eventsById: {}, summaryById: {}, activeId: null };

    function _fmt(val) { return (val === undefined || val === null) ? "" : String(val); }

    function _nowDateClean(){
        return new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    }

    function _nowTime(){
        // HH:mm:ss always (24h). Storage must not depend on locale quirks.
        return new Intl.DateTimeFormat('pt-PT', {
            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
        }).format(new Date());
    }

    function _dtKey(dateClean, timeStr) {
        return (_fmt(dateClean) + " " + _fmt(timeStr)).trim(); // YYYY-MM-DD HH:mm:ss
    }

    

    // Cache + helper to retrieve picking operator from registos when active_batches fields are not writable
    const _pickingInfoCache = {};
    async function getPickingInfo(batchId){
        if(!batchId) return null;
        if(_pickingInfoCache[batchId]) return _pickingInfoCache[batchId];
        try{
            const snap = await db.ref('registos').orderByChild('batch').equalTo(batchId).once('value');
            let best = null;
            Object.values(snap.val() || {}).forEach(r => {
                if(r && (r.mode === "PICKING" || r.msg === "PICKING COMPLETE")){
                    const ts = (typeof r.ts === 'number') ? r.ts : 0;
                    if(!best || ts > (best.ts||0)) best = r;
                }
            });
            if(best){
                _pickingInfoCache[batchId] = { pickedBy: best.user, pickedAt: best.DateTime || _dtKey(best.dateClean, best.time), ts: best.ts||0 };
                return _pickingInfoCache[batchId];
            }
        }catch(e){
            console.warn("getPickingInfo failed", e);
        }
        return null;
    }
function _nowDateTime(){
        const dc = _nowDateClean();
        const tm = _nowTime();
        return _dtKey(dc, tm);
    }

    function _ptLocaleToDateTime(str){
        // Accepts: "DD/MM/YYYY, HH:MM:SS" or "DD/MM/YYYY HH:MM" etc.
        const s = _fmt(str).trim();
        const m = s.match(/(\d{2})\/(\d{2})\/(\d{4}).*?(\d{2}):(\d{2})(?::(\d{2}))?/);
        if(!m) return "";
        const dd=m[1], mm=m[2], yyyy=m[3], hh=m[4], mi=m[5], ss=(m[6]||"00");
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    }

    function _normalizeDT(val, dateCleanFallback){
        const s = _fmt(val).trim();
        if(!s) return "";
        // Already ISO-ish
        if(/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/.test(s)) return s;

        // pt-PT locale string -> normalize to ISO-ish
        const pt = _ptLocaleToDateTime(s);
        if(pt) return pt;

        // Time-only -> combine with dateClean
        if(/^\d{2}:\d{2}(:\d{2})?$/.test(s)){
            const t = (s.length === 5) ? (s + ":00") : s;
            return _dtKey(dateCleanFallback || _nowDateClean(), t);
        }

        // Fallback: return as-is
        return s;
    }
function _parseIds(raw) {
        return raw.split(/[\s,]+/).map(function(x){ return x.trim(); }).filter(function(x){ return x !== ""; });
    }

    function _getSearchFilters() {
        var s = document.getElementById('search-start-date');
        var e = document.getElementById('search-end-date');
        var t = document.getElementById('search-type-filter');
        var st = document.getElementById('search-status-filter');

        return {
            start: s ? s.value : "",
            end: e ? e.value : "",
            type: t ? t.value : "ALL",
            status: st ? st.value : "ALL"
        };
    }

    function _passesType(typeVal, filterVal) {
        if (!filterVal || filterVal === "ALL") return true;
        return typeVal === filterVal;
    }

    function _passesDate(dt, start, end) {
        // dt format: "YYYY-MM-DD ..." or locale string; we use prefix compare when possible.
        if (!start && !end) return true;
        var d = _fmt(dt).slice(0, 10);
        if (start && d < start) return false;
        if (end && d > end) return false;
        return true;
    }

    function _renderTimeline(events) {
        var box = document.getElementById('id-history-timeline');
        if (!box) return;

        if (!events || !events.length) {
            box.innerHTML = "<div style='padding:12px; color:#666;'>No events for this filter.</div>";
            return;
        }

        var html = "<div style='position:relative; margin-left: 16px; border-left: 3px solid #e5e7eb; padding-left: 18px;'>";
        events.forEach(function(ev){
            var type = _fmt(ev.Type);
            var dot = "var(--accent)";
            if (type === "PACKING") dot = "var(--packing)";
            if (type === "RETURNS") dot = "var(--returns)";
            if (type === "CANCELLED") dot = "var(--error)";
            if (type.indexOf("OFFICE") === 0) dot = "var(--primary)";

            html += "<div style='position:relative; margin: 14px 0;'>";
            html += "<div style='position:absolute; left:-28px; top: 8px; width:14px; height:14px; border-radius:999px; background:" + dot + "; box-shadow:0 0 0 4px rgba(0,0,0,0.06);'></div>";
            html += "<div style='background:white; border:1px solid #eee; border-radius:14px; padding:12px 14px; box-shadow: 0 3px 10px rgba(0,0,0,0.04);'>";
            html += "<div style='display:flex; justify-content:space-between; gap:10px; align-items:center;'>";
            html += "<div style='font-weight:900;'>" + type + "</div>";
            html += "<div style='font-size:12px; color:#666;'>" + _fmt(ev.DateTime) + "</div>";
            html += "</div>";
            var meta = [];
            if (_fmt(ev.Batch)) meta.push("<b>Batch:</b> " + _fmt(ev.Batch));
            if (_fmt(ev.Carrier)) meta.push("<b>Carrier:</b> " + _fmt(ev.Carrier));
            if (_fmt(ev.User)) meta.push("<b>User:</b> " + _fmt(ev.User));
            if (_fmt(ev.Tracking)) meta.push("<b>Track:</b> " + _fmt(ev.Tracking));
            if (_fmt(ev.Items_or_Content)) meta.push("<b>Items:</b> " + _fmt(ev.Items_or_Content));
            if (meta.length) html += "<div style='margin-top:8px; font-size:13px; line-height:1.35;'>" + meta.join(" &nbsp; | &nbsp; ") + "</div>";
            if (_fmt(ev.Details)) html += "<div style='margin-top:8px; font-size:12px; color:#444;'><small>" + _fmt(ev.Details) + "</small></div>";
            html += "</div>";
            html += "</div>";
        });
        html += "</div>";
        box.innerHTML = html;
    }

    function _renderSearchCards() {
        var container = document.getElementById('search-cards-container');
        if (!container) return;
        container.innerHTML = "";

        if (!searchCache.ids || searchCache.ids.length === 0) {
            container.innerHTML = "<div class='card' style='grid-column: 1 / -1;'><b>No IDs.</b></div>";
            return;
        }

        var anyFound = false;
        var filters = _getSearchFilters();

        searchCache.ids.forEach(function(id){
            var s = searchCache.summaryById[id] || {};
            var events = searchCache.eventsById[id] || [];
            if (events.length > 0) anyFound = true;

            // apply status filter to cards (summary-based)
            var status = _fmt(s.status || (events.length ? "FOUND" : "NOT FOUND"));
            if (filters.status !== "ALL" && status !== filters.status) return;

            var last = _fmt(s.lastEvent || "");
            var batchName = _fmt(s.batchName || "");
            var carrier = _fmt(s.carrier || "");
            var cancelReason = _fmt(s.cancelReason || "");
            var packedBy = _fmt(s.packedBy || "");
            var tracking = _fmt(s.tracking || "");

            var badgeColor = (status === "CANCELLED") ? "var(--returns)" : (status === "PACKED" ? "var(--packing)" : (status === "PENDING" ? "var(--accent)" : "var(--primary)"));

            var card = document.createElement('div');
            card.className = "card";
            card.style.padding = "18px";

            var top = "<div style='display:flex; justify-content:space-between; align-items:center; gap:10px;'>"
                + "<div style='font-size:20px; font-weight:900;'>ID " + id + "</div>"
                + "<div style='background:" + badgeColor + "; color:white; padding:6px 10px; border-radius:10px; font-weight:900; font-size:12px;'>" + status + "</div>"
                + "</div>";

            var lines = "";
            if (batchName) lines += "<div style='margin-top:10px; font-size:14px;'><b>Batch:</b> " + batchName + "</div>";
            if (carrier) lines += "<div style='font-size:14px;'><b>Carrier:</b> " + carrier + "</div>";
            if (packedBy) lines += "<div style='font-size:14px;'><b>Packed by:</b> " + packedBy + "</div>";
            if (tracking) lines += "<div style='font-size:14px;'><b>Tracking:</b> " + tracking + "</div>";
            if (cancelReason) lines += "<div style='font-size:14px; color: var(--error);'><b>Cancel:</b> " + cancelReason + "</div>";
            if (last) lines += "<div style='margin-top:8px; font-size:12px; color:#666;'><b>Last event:</b> " + last + "</div>";

            var btns = "<div style='display:flex; gap:10px; margin-top:15px;'>"
                + "<button class='btn-small' style='background: var(--primary); flex:1; padding:12px;' onclick=\"openIdHistoryModal('" + id + "')\">OPEN HISTORY</button>"
                + "<button class='btn-small' style='background: var(--accent); padding:12px;' onclick=\"exportIdHistoryDirect('" + id + "')\">EXPORT</button>"
                + "</div>";

            card.innerHTML = top + lines + btns;
            container.appendChild(card);
        });

        if (!anyFound) {
            var note = document.createElement('div');
            note.className = "card";
            note.style.gridColumn = "1 / -1";
            note.innerHTML = "<b>No history found for the provided IDs (within filters).</b>";
            container.appendChild(note);
        }
    }

    function _fillModalFiltersFromSearch() {
        var f = _getSearchFilters();
        var ms = document.getElementById('modal-start-date');
        var me = document.getElementById('modal-end-date');
        var mt = document.getElementById('modal-type-filter');
        var mst = document.getElementById('modal-status-filter');
        if (ms) ms.value = f.start || "";
        if (me) me.value = f.end || "";
        if (mt) mt.value = f.type || "ALL";
        if (mst) mst.value = (f.status && f.status !== "NOT FOUND") ? f.status : "ALL";
    }

    function openIdHistoryModal(id) {
        searchCache.activeId = id;
        _fillModalFiltersFromSearch();

        var title = document.getElementById('id-history-title');
        if (title) title.innerText = "ID History - " + id;

        // Render initial with filters
        applyIdHistoryFilters();

        document.getElementById('id-history-modal').style.display = 'flex';
    }

    function applyIdHistoryFilters() {
        var id = searchCache.activeId;
        if (!id) return;

        var ms = document.getElementById('modal-start-date');
        var me = document.getElementById('modal-end-date');
        var mt = document.getElementById('modal-type-filter');
        var mst = document.getElementById('modal-status-filter');

        var start = ms ? ms.value : "";
        var end = me ? me.value : "";
        var typeF = mt ? mt.value : "ALL";
        var statusF = mst ? mst.value : "ALL";

        var summary = searchCache.summaryById[id] || {};
        var sumEl = document.getElementById('id-history-summary');
        if (sumEl) {
            var parts = [];
            if (summary.batchName) parts.push("<b>Batch:</b> " + _fmt(summary.batchName));
            if (summary.carrier) parts.push("<b>Carrier:</b> " + _fmt(summary.carrier));
            if (summary.customer) parts.push("<b>Customer:</b> " + _fmt(summary.customer));
            if (summary.expectedContent) parts.push("<b>Expected:</b> " + _fmt(summary.expectedContent));
            parts.push("<b>Status:</b> " + _fmt(summary.status || ""));
            if (summary.cancelReason) parts.push("<b>Cancel reason:</b> " + _fmt(summary.cancelReason) + " (" + _fmt(summary.cancelBy) + " @ " + _fmt(summary.cancelAt) + ")");
            if (summary.packedBy) parts.push("<b>Packed by:</b> " + _fmt(summary.packedBy) + " @ " + _fmt(summary.packedAt));
            if (summary.tracking) parts.push("<b>Tracking:</b> " + _fmt(summary.tracking));
            sumEl.innerHTML = parts.join(" &nbsp; | &nbsp; ") || "";
        }

        var allEvents = searchCache.eventsById[id] || [];
        var filtered = allEvents.filter(function(ev){
            if (!_passesDate(ev.DateTime, start, end)) return false;
            if (!_passesType(_fmt(ev.Type), typeF)) return false;
            // status filter in modal is summary-based; apply CANCELLED/PACKED to event types for usability
            if (statusF === "CANCELLED" && _fmt(ev.Type) !== "CANCELLED") return false;
            if (statusF === "PACKED" && _fmt(ev.Type) !== "PACKING") return false;
            if (statusF === "PENDING") {
                // Pending = show OFFICE created + (optional) returns, but exclude packed/cancel events
                if (_fmt(ev.Type) === "PACKING" || _fmt(ev.Type) === "CANCELLED") return false;
            }
            return true;
        });

        // Table
        var tbody = document.querySelector('#id-history-table tbody');
        if (tbody) tbody.innerHTML = "";
        filtered.forEach(function(ev){
            if (!tbody) return;
            tbody.innerHTML += "<tr>"
                + "<td>" + _fmt(ev.DateTime) + "</td>"
                + "<td><b>" + _fmt(ev.Type) + "</b></td>"
                + "<td>" + _fmt(ev.Batch) + "</td>"
                + "<td>" + _fmt(ev.Carrier) + "</td>"
                + "<td>" + _fmt(ev.User) + "</td>"
                + "<td>" + _fmt(ev.Tracking) + "</td>"
                + "<td><small>" + _fmt(ev.Items_or_Content) + "</small></td>"
                + "<td><small>" + _fmt(ev.Details) + "</small></td>"
                + "</tr>";
        });

        // Timeline
        _renderTimeline(filtered);
    }

    function exportIdHistory() {
        if (!searchCache.activeId) return alert("No active ID.");
        exportIdHistoryDirect(searchCache.activeId);
    }

    function exportIdHistoryDirect(id) {
        var events = searchCache.eventsById[id] || [];
        if (!events.length) return alert("No history to export for this ID.");
        var ws = XLSX.utils.json_to_sheet(events);
        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ID_History");
        var ts = new Date().toISOString().replace(/[:.]/g,'-');
        XLSX.writeFile(wb, "WH_ID_History_" + id + "_" + ts + ".xlsx");
    }

    function exportAllSearchHistories() {
        if (!searchCache.ids || searchCache.ids.length === 0) return alert("No IDs.");
        var all = [];
        searchCache.ids.forEach(function(id){
            var evs = searchCache.eventsById[id] || [];
            evs.forEach(function(e){
                var row = {};
                row.ID = id;
                row.DateTime = e.DateTime;
                row.Type = e.Type;
                row.Batch = e.Batch;
                row.Carrier = e.Carrier;
                row.User = e.User;
                row.Tracking = e.Tracking;
                row.Items_or_Content = e.Items_or_Content;
                row.Details = e.Details;
                all.push(row);
            });
        });
        if (!all.length) return alert("No history to export.");
        var ws = XLSX.utils.json_to_sheet(all);
        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Search_All");
        var ts = new Date().toISOString().replace(/[:.]/g,'-');
        XLSX.writeFile(wb, "WH_Search_All_" + ts + ".xlsx");
    }

    async function searchOrderHistory() {
        var inputEl = document.getElementById('search-ids-input');
        var input = inputEl ? inputEl.value : "";
        if(!input.trim()) return alert("Enter IDs.");

        var idsToSearch = _parseIds(input);
        searchCache.ids = idsToSearch;
        searchCache.eventsById = {};
        searchCache.summaryById = {};
        searchCache.activeId = null;

        var container = document.getElementById('search-cards-container');
        if (container) container.innerHTML = "<div class='card' style='grid-column: 1 / -1;'><b>Searching...</b></div>";

        var filters = _getSearchFilters();
        var start = filters.start;
        var end = filters.end;

        var allBox = document.getElementById('search-all-records');
        var searchAll = allBox ? allBox.checked : false;

        var regPromise, batchPromise;

        if (searchAll) {
            // FULL SCAN (slow)
            if (!confirm("SEARCH ALL RECORDS pode demorar. Continuar?")) {
                if (container) container.innerHTML = "<div class='card' style='grid-column: 1 / -1;'><b>Search cancelled.</b></div>";
                return;
            }
            regPromise = db.ref('registos').once('value');
            batchPromise = db.ref('active_batches').once('value');
        } else {
            // PERFORMANCE: only pull data in the selected date range (needs index on dateClean)
            var regRef = db.ref('registos');
            if (start && end) regRef = regRef.orderByChild('dateClean').startAt(start).endAt(end);
            else regRef = regRef.orderByChild('dateClean');

            var batchRef = db.ref('active_batches');
            if (start && end) batchRef = batchRef.orderByChild('dateClean').startAt(start).endAt(end);
            else batchRef = batchRef.orderByChild('dateClean');

            regPromise = regRef.once('value');
            batchPromise = batchRef.once('value');
        }

        var regSnap = await regPromise;
        var batchSnap = await batchPromise;

        var regData = regSnap.val() || {};
        var batchData = batchSnap.val() || {};

        idsToSearch.forEach(function(sid){
            var events = [];
            var summary = { status: "PENDING" };

            // BATCH CREATED + CANCELLED from active_batches (range-limited)
            Object.entries(batchData).forEach(function(entry){
                var k = entry[0], b = entry[1];
                if(!b) return;

                var exp = b.expected_ids || [];
                if(exp.indexOf(sid) === -1) return;

                var batchName = b.name || k;
                var carrier = b.carrier || "N/A";
                var od = (b.order_details && b.order_details[sid]) ? b.order_details[sid] : {};

                if (!summary.batchKey) {
                    summary.batchKey = k;
                    summary.batchName = batchName;
                    summary.carrier = carrier;
                    summary.customer = _fmt(od.name);
                    summary.expectedContent = _fmt(od.content);
                }

                var createdDT = "";
                if (b.createdDateClean && b.createdTime) {
                    createdDT = _dtKey(b.createdDateClean, b.createdTime);
                } else {
                    createdDT = _normalizeDT(b.createdAt, b.dateClean) || _dtKey(b.dateClean, "00:00:00");
                }
                if (_passesDate(createdDT, start, end) && _passesType("OFFICE / BATCH_CREATED", filters.type)) {
                    events.push({
                        DateTime: createdDT,
                        Type: "OFFICE / BATCH_CREATED",
                        Batch: batchName,
                        Carrier: carrier,
                        User: _fmt(b.createdBy || "SYSTEM"),
                        Tracking: "",
                        Items_or_Content: _fmt(od.content),
                        Details: "Added to batch | Customer: " + _fmt(od.name)
                    });
                }

                if(b.cancelled_ids && b.cancelled_ids[sid]) {
                    var c = b.cancelled_ids[sid];
                    var cancelDT = "";
                    if (c.DateTime) cancelDT = _normalizeDT(c.DateTime, c.dateClean || b.dateClean);
                    else if (c.dateClean && c.time) cancelDT = _dtKey(c.dateClean, c.time);
                    else cancelDT = _normalizeDT(c.time, c.dateClean || b.dateClean);
                    if (_passesDate(cancelDT, start, end) && _passesType("CANCELLED", filters.type)) {
                        events.push({
                            DateTime: cancelDT,
                            Type: "CANCELLED",
                            Batch: batchName,
                            Carrier: carrier,
                            User: _fmt(c.user),
                            Tracking: "",
                            Items_or_Content: "",
                            Details: "Reason: " + _fmt(c.reason)
                        });
                    }
                    summary.status = "CANCELLED";
                    summary.cancelReason = _fmt(c.reason);
                    summary.cancelBy = _fmt(c.user);
                    summary.cancelAt = _fmt(cancelDT);
                }
            });

            // PACKING/RETURNS from registos (range-limited)
            Object.values(regData).forEach(function(r){
                if(!r || r.id !== sid) return;
                if(r.mode !== 'PACKING' && r.mode !== 'RETURN') return;

                var batchKey = r.batch || "GENERAL";
                // batchData in range may not include this batch if its dateClean outside range; fallback read minimal batch info not done (perf tradeoff)
                var b = batchData[batchKey] || {};
                var batchName = b.name || batchKey;
                var carrier = b.carrier || "N/A";
                var od = (b.order_details && b.order_details[sid]) ? b.order_details[sid] : {};

                if(r.mode === 'PACKING') {
                    if (!_passesType("PACKING", filters.type)) return;
                    var dt = _dtKey(r.dateClean, r.endTime || r.time);
                    events.push({
                        DateTime: dt,
                        Type: "PACKING",
                        Batch: batchName,
                        Carrier: carrier,
                        User: _fmt(r.user),
                        Tracking: _fmt(r.track),
                        Items_or_Content: _fmt(r.prods),
                        Details: "Start: " + _fmt(r.startTime || r.time) + " | Confirm: " + _fmt(r.endTime || r.time)
                            + " | Customer: " + _fmt(od.name) + " | Expected: " + _fmt(od.content)
                    });

                    if (summary.status !== "CANCELLED") {
                        summary.status = "PACKED";
                        summary.packedBy = _fmt(r.user);
                        summary.packedAt = dt;
                        summary.tracking = _fmt(r.track);
                    }
                } else {
                    if (!_passesType("RETURNS", filters.type)) return;
                    var dtR = _dtKey(r.dateClean, r.time);
                    events.push({
                        DateTime: dtR,
                        Type: "RETURNS",
                        Batch: batchName,
                        Carrier: carrier,
                        User: _fmt(r.user),
                        Tracking: _fmt(r.track),
                        Items_or_Content: _fmt(r.prods),
                        Details: "Return saved"
                    });
                }
            });

            events.sort(function(a, b){
                return _fmt(b.DateTime).localeCompare(_fmt(a.DateTime));
            });

            if (!events.length) summary.status = "NOT FOUND";
            summary.lastEvent = events.length ? _fmt(events[0].DateTime) : "";

            searchCache.eventsById[sid] = events;
            searchCache.summaryById[sid] = summary;
        });

        _renderSearchCards();
    }

    function loadPerformanceStats() {
        const date = document.getElementById('perf-date-filter').value;
        const tbody = document.querySelector('#perf-table tbody');
        let stats = {};
        db.ref('registos').once('value', snap => {
            db.ref('pre_packing').once('value', preSnap => {
                Object.values(snap.val() || {}).forEach(r => { if(r.dateClean === date) { if(!stats[r.user]) stats[r.user] = { p:0, r:0, pre:0 }; if(r.mode === 'PACKING') stats[r.user].p++; if(r.mode === 'RETURN') stats[r.user].r++; } });
                Object.values(preSnap.val() || {}).forEach(p => { if(p.dateClean === date) { if(!stats[p.user]) stats[p.user] = { p:0, r:0, pre:0 }; stats[p.user].pre++; } });
                tbody.innerHTML = "";
                Object.keys(stats).sort().forEach(u => { const s = stats[u]; tbody.innerHTML += `<tr><td><b>${u}</b></td><td>${s.p}</td><td>${s.r}</td><td>${s.pre}</td><td>${s.p+s.r+s.pre}</td></tr>`; });
            });
        });
    }

    function logBatchAction(bId, msg) {
        const dc = _nowDateClean();
        const tm = _nowTime();
        return db.ref(`active_batches/${bId}/history`).push({
            dateClean: dc,
            time: tm,
            DateTime: _dtKey(dc, tm),
            ts: Date.now(),
            user: currentUser.email.split('@')[0].toUpperCase(),
            msg
        });
    }

    function openEditModal(batchId, readOnly = false) {
        if(!batchId) return;
        // Keep only one modal listener at a time
        if(__modalBatchRef && __modalBatchCb){ __modalBatchRef.off('value', __modalBatchCb); }
        __modalBatchRef = db.ref('active_batches/'+batchId);
        __modalBatchCb = (snap) => {
            const b = snap.val(); if(!b) return;
            document.getElementById('edit-batch-title').innerText = b.name;

const metaEl = document.getElementById('edit-batch-meta');
if(metaEl){
    const parts = [];
    parts.push(`<div><b>Status:</b> ${_fmt(b.status)}</div>`);
    if (b.carrier) parts.push(`<div><b>Carrier:</b> ${_fmt(b.carrier)}</div>`);
    if (b.pickedBy) parts.push(`<div><b>Picked by:</b> ${_fmt(b.pickedBy)}${b.pickedAt ? ` <span style="color:#666;">@ ${_fmt(b.pickedAt)}</span>` : ''}</div>`);
    metaEl.innerHTML = parts.join('');

    if(!b.pickedBy){
        getPickingInfo(batchId).then(info => {
            if(info && info.pickedBy){
                const parts2 = [];
                parts2.push(`<div><b>Status:</b> ${_fmt(b.status)}</div>`);
                if (b.carrier) parts2.push(`<div><b>Carrier:</b> ${_fmt(b.carrier)}</div>`);
                parts2.push(`<div><b>Picked by:</b> ${_fmt(info.pickedBy)}${info.pickedAt ? ` <span style="color:#666;">@ ${_fmt(info.pickedAt)}</span>` : ''}</div>`);
                metaEl.innerHTML = parts2.join('');
            }
        });
    }
}
            document.getElementById('modal-delete-btn').style.display = (readOnly || !currentUser.email.endsWith('@admin.com')) ? 'none' : 'block';
            const tbody = document.querySelector('#edit-inventory-table tbody'); tbody.innerHTML = "";
            Object.keys(b.inventory || {}).sort().forEach(k => {
                const it = b.inventory[k];
                tbody.innerHTML += `<tr><td>${k}</td><td>${readOnly ? it.q : `<input type="number" style="width:70px;" value="${it.q}" onchange="db.ref('active_batches/${batchId}/inventory/${k}/q').set(parseInt(this.value))">`}</td><td>${it.pos}</td>${readOnly ? '' : `<td><button class="btn-small btn-delete" onclick="db.ref('active_batches/${batchId}/inventory/${k}').remove()">X</button></td>`}</tr>`;
            });
            const idsList = document.getElementById('edit-ids-list');
            let html = '<table><thead><tr><th>ID</th><th>Cliente</th><th>Content</th><th>Status</th><th>A√ß√£o</th></tr></thead><tbody>';
            (b.expected_ids||[]).forEach(id => {
                const isPack = (b.processed_ids && b.processed_ids[id]);
                const isCancel = (b.cancelled_ids && b.cancelled_ids[id]);
                const det = (b.order_details||{})[id] || {name:"N/A"};
                const cancelInfo = isCancel ? b.cancelled_ids[id] : null;

                const statusTxt = isCancel ? 'CANCELLED' : (isPack ? 'PACKED' : 'PENDING');
                const statusColor = isCancel ? 'var(--error)' : (isPack ? 'green' : 'orange');
                const rowCls = isCancel ? 'cancelled-row' : '';
                const idCls = isCancel ? 'cancelled-id' : '';
                const reason = cancelInfo ? (cancelInfo.reason || '') : '';

                html += `<tr class="${rowCls}">
                            <td>
                                <b class="${idCls}" title="${reason ? ('CANCELLED: ' + reason) : ''}">${id}</b>
                            </td>
                            <td>${det.name}</td>
                            <td><small>${det.content || 'N/A'}</small></td>
                            <td style="color:${statusColor}; font-weight:900;">${statusTxt}</td>
                            <td>${
                                readOnly ? '' : (isCancel ? '' : `<button class="btn-small btn-delete" onclick="cancelBatchId('${batchId}', '${id}')">CANCEL</button>`)
                            }</td>
                         </tr>`;
            });
idsList.innerHTML = html + '</tbody></table>';
            const logBox = document.getElementById('qty-modification-log'); logBox.innerHTML = "";
            if(b.history) { Object.values(b.history).reverse().forEach(log => { logBox.innerHTML += `<div style="border-bottom:1px solid #eee; padding:4px;"><b>[${(log.DateTime || (log.dateClean && log.time ? _dtKey(log.dateClean, log.time) : log.time))}] ${log.user}:</b> ${log.msg}</div>`; }); }
            const cancelBox = document.getElementById('cancelled-ids-log'); cancelBox.innerHTML = "";
            if(b.cancelled_ids) { Object.values(b.cancelled_ids).reverse().forEach(c => { cancelBox.innerHTML += `<div><b>ID ${c.id}:</b> ${c.reason} <br><small>By ${c.user} at ${ (c.DateTime || (c.dateClean && c.time ? (_dtKey(c.dateClean, c.time)) : c.time) ) }</small></div>`; }); }
            document.getElementById('edit-batch-modal').style.display = 'flex';
        };
        __modalBatchRef.on('value', __modalBatchCb);
    }

    function loadBatchData(bId) {
        if(!bId) return; localStorage.setItem('lastPackingBatch', bId);
        if(activeBatchPath) db.ref(activeBatchPath).off();
        activeBatchPath = 'active_batches/' + bId;
        db.ref(activeBatchPath).on('value', s => {
            activeBatchData = s.val(); if(!activeBatchData) return;
            document.getElementById('btn-finalize-batch').style.display = 'block';
            updateProcessedTable(bId);
        });
    }

    function updateProcessedTable(bId) {
        // Listen only to records for this batch (avoid pulling ALL registos)
        if(__processedRegRef && __processedRegCb){ __processedRegRef.off('value', __processedRegCb); }

        __processedRegRef = db.ref('registos').orderByChild('batch').equalTo(bId).limitToLast(5000);
        __processedRegCb = (snap) => {
            const tbody = document.querySelector('#recent-scans-table tbody');
            if(!tbody) return;
            tbody.innerHTML = "";

            const rows = [];
            snap.forEach(ch => {
                const key = ch.key;
                const r = ch.val() || {};
                if(!r || r.batch !== bId) return;
                if((r.mode || "").toString().toUpperCase() !== 'PACKING') return;
                rows.push({ key, r });
            });

            // newest first by DateTime/ts
            rows.sort((a,b) => {
                const ra=a.r||{}, rb=b.r||{};
                const dta = (ra.DateTime || _dtKey(ra.dateClean||"", ra.endTime||ra.time||""));
                const dtb = (rb.DateTime || _dtKey(rb.dateClean||"", rb.endTime||rb.time||""));
                return _fmt(dtb).localeCompare(_fmt(dta));
            });

            rows.forEach(({key, r}) => {
                const det = (activeBatchData && activeBatchData.order_details && activeBatchData.order_details[r.id])
                    ? activeBatchData.order_details[r.id]
                    : {name:"---"};
                tbody.innerHTML += `<tr><td>${_fmt(r.time)}</td><td><b>${_fmt(r.id)}</b></td><td>${_fmt(det.name)}</td><td><button class="btn-small btn-delete" onclick="removeRecentScan('${key}', '${_fmt(r.id)}', '${_fmt(r.prods)}', '${bId}')">X</button></td></tr>`;
            });
        };

        __processedRegRef.on('value', __processedRegCb);
    }

    function removeRecentScan(recId, orderId, itemsStr, bId) { if(!confirm(`Apagar registo do ID ${orderId}?`)) return; db.ref('registos/' + recId).remove().then(() => { if(bId) db.ref(`active_batches/${bId}/processed_ids/${orderId}`).remove(); }); }

    function finishBatchPacking() {
        if(!activeBatchData) return;

        const requiredIds = getRequiredBatchIds(activeBatchData);
        const processedMap = activeBatchData.processed_ids || {};

        const processedRequiredCount = requiredIds.filter(id => processedMap[id]).length;
        const requiredCount = requiredIds.length;

        if(processedRequiredCount < requiredCount) {
            const missing = requiredIds.filter(id => !processedMap[id]);
            // show up to 10 missing to avoid huge alerts
            const sample = missing.slice(0, 10).join(', ');
            const more = missing.length > 10 ? ` (+${missing.length - 10} more)` : '';
            return alert(`ERRO: Faltam ${requiredCount - processedRequiredCount} IDs (excluindo cancelados).
Missing: ${sample}${more}`);
        }

        if(confirm("Fechar lote permanentemente? (IDs cancelados n√£o bloqueiam)")) {
            db.ref(activeBatchPath).update({status: 'COMPLETED'}).then(() => {
                localStorage.removeItem('lastPackingBatch');
                location.reload();
            });
        }
    }


    function loadPickingList() {
        const bId = document.getElementById('pick-batch-select').value; if(!bId) return;
        db.ref('active_batches/'+bId).once('value', snap => {
            const container = document.getElementById('picking-list-container'); container.innerHTML = "";
            Object.keys(snap.val().inventory || {}).forEach(k => {
                const it = snap.val().inventory[k];
                container.innerHTML += `<div style="display:flex; align-items:center; padding:10px; border-bottom:1px solid #eee;"><input type="checkbox" class="pk-check" style="width:30px; height:30px; margin-right:15px;"><span><b>${it.q}x</b> - ${k}</span><span class="location-tag">üìç ${it.pos}</span></div>`;
            });
            document.getElementById('btn-select-all').style.display = 'block'; document.getElementById('btn-pick-details').style.display = 'block'; document.getElementById('btn-finish-picking').style.display = 'block';
        });
    }

    function selectAllPicking() { document.querySelectorAll('.pk-check').forEach(c => c.checked = true); }
    function finishPicking() {
    const bId = document.getElementById('pick-batch-select').value;
    if(!bId) return;

    if(!currentUser || !currentUser.email) {
        return alert("ERRO: utilizador n√£o autenticado.");
    }

    const pickedBy = currentUser.email.split('@')[0].toUpperCase();
    const dc = _nowDateClean();
    const tm = _nowTime();
    const dt = _dtKey(dc, tm);

    // Keep original behavior first: update only the status (most likely allowed by rules)
    db.ref('active_batches/' + bId).update({ status: 'READY_TO_PACK' })
    .then(() => {
        // Best-effort extra writes (do not block finishing picking if rules reject them)
        const extra = [
            db.ref('active_batches/' + bId).update({
                pickedBy: pickedBy,
                pickedDateClean: dc,
                pickedTime: tm,
                pickedAt: dt
            }),
            // Local history (if permitted)
            db.ref(`active_batches/${bId}/history`).push({
                dateClean: dc,
                time: tm,
                DateTime: dt,
                ts: Date.now(),
                user: pickedBy,
                msg: "PICKING COMPLETE"
            }),
            // Global activity log (if permitted)
            db.ref('registos').push({
                mode: "PICKING",
                batch: bId,
                user: pickedBy,
                dateClean: dc,
                time: tm,
                DateTime: dt,
                ts: Date.now()
            })
        ];
        return Promise.allSettled(extra);
    })
    .then(() => location.reload())
    .catch(err => {
        console.error(err);
        alert("Erro ao finalizar picking. Ver consola.");
    });
}

    function renderManagementUI(all, fD) {
        const container = document.getElementById('mgmt-container'); container.innerHTML = "";
        let gr = {}; for(let k in all) { let b = all[k]; if(b.dateClean === fD) { if(!gr[b.carrier]) gr[b.carrier] = []; gr[b.carrier].push({ ...b, id: k }); } }
        for(let c in gr) {
            let col = document.createElement('div'); col.className = 'carrier-column';
            let color = c.includes('CTT')?'var(--color-ctt)':(c.includes('NACEX')?'var(--color-nacex)':'var(--color-correos)');
            let h = `<div class="carrier-header" style="background:${color}">${c}</div>`;
            gr[c].forEach(b => {
                const requiredIds = getRequiredBatchIds(b);
                const tot = requiredIds.length, done = requiredIds.filter(id => (b.processed_ids && b.processed_ids[id])).length;
                const perc = tot > 0 ? Math.round((done / tot) * 100) : 0;
                h += `<div class="batch-card"><h4>${b.name}</h4><div style="display:flex; justify-content:space-between; font-size:12px; color:#666;"><span>${perc}% Done</span><span>Status: ${b.status}</span></div>${b.pickedBy ? '<div style="margin-top:6px; font-size:12px; color:#444;"><b>Picked by:</b> ' + b.pickedBy + (b.pickedAt ? ' <span style="color:#666;">@ ' + b.pickedAt + '</span>' : '') + '</div>' : ''}<div class="progress-container"><div class="progress-bar" style="width:${perc}%"></div></div><div style="display:flex; gap:10px; margin-top:15px;"><button class="btn-small" style="background:var(--accent); flex:1;" onclick="openEditModal('${b.id}', false)">EDIT</button><button class="btn-small btn-delete" onclick="deleteBatch('${b.id}')">DEL</button></div></div>`;
            });
            col.innerHTML = h; container.appendChild(col);
        }
    }

    function __stopOverviewRealtime(){
        if(__overviewBatchesRef && __overviewBatchesCb){ __overviewBatchesRef.off('value', __overviewBatchesCb); }
        if(__overviewPrepackRef && __overviewPrepackCb){ __overviewPrepackRef.off('value', __overviewPrepackCb); }
        __overviewBatchesRef = null; __overviewBatchesCb = null;
        __overviewPrepackRef = null; __overviewPrepackCb = null;
    }

    function __renderOverviewForDate(fD){
        const bts = __overviewCacheBatches || {};
        updateDashboardStats(bts, fD, __overviewCachePrepackCount);
        updatePickingMiniDashboard(bts, fD);
        renderManagementUI(bts, fD);
        updateSelects(bts, fD);
    }

    function __bindConfigListenersOnce(){
        if(__cfgBound) return;
        __cfgBound = true;

        // Small config nodes can stay realtime (low traffic)
        db.ref('config/master_products').on('value', s => { masterProductsDB = s.val() || {}; });
        db.ref('config/carriers').on('value', s => {
            const carriers = s.val() || ["CTT", "NACEX", "CORREOS"]; 
            const sel = document.getElementById('off-carrier-select');
            if(sel) {
                sel.innerHTML = "";
                carriers.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
            }
        });
    }


    // --- PICKING DATE FILTER (allows future batches, e.g., tomorrow) ---
    function setPickingDate(d){
        const gd = document.getElementById('global-date-filter');
        if(gd) gd.value = d;
        syncGlobalData();
    }

    // --- PACKING DATE FILTER (allows packing tomorrow batches, etc.) ---
    function setPackingDate(d){
        const gd = document.getElementById('global-date-filter');
        if(gd) gd.value = d;
        syncGlobalData();
    }

    async function syncGlobalData() {
        __bindConfigListenersOnce();

        const fD = document.getElementById('global-date-filter').value;
        try {
            const pk = document.getElementById('pick-date-filter');
            if(pk && pk.value !== fD) pk.value = fD;
        } catch(e) {}
        try {
            const pa = document.getElementById('pack-date-filter');
            if(pa && pa.value !== fD) pa.value = fD;
        } catch(e) {}
        const today = _nowDateClean();

        // Realtime only when viewing TODAY
        if(fD === today) {
            // Active batches realtime
            if(!__overviewBatchesRef) {
                __overviewBatchesRef = db.ref('active_batches');
                __overviewBatchesCb = (snap) => {
                    __overviewCacheBatches = snap.val() || {};
                    __renderOverviewForDate(fD);
                };
                __overviewBatchesRef.on('value', __overviewBatchesCb);
            }

            // Pre-pack count realtime only for today
            if(!__overviewPrepackRef) {
                __overviewPrepackRef = db.ref('pre_packing').orderByChild('dateClean').equalTo(today);
                __overviewPrepackCb = (snap) => {
                    __overviewCachePrepackCount = snap.numChildren() || 0;
                    __renderOverviewForDate(fD);
                };
                __overviewPrepackRef.on('value', __overviewPrepackCb);
            }

            // Render immediately using whatever cache we have
            __renderOverviewForDate(fD);
            return;
        }

        // Older dates: no realtime listeners; load only on demand
        __stopOverviewRealtime();

        try {
            const [bSnap, pSnap] = await Promise.all([
                db.ref('active_batches').once('value'),
                db.ref('pre_packing').orderByChild('dateClean').equalTo(fD).once('value')
            ]);
            __overviewCacheBatches = bSnap.val() || {};
            __overviewCachePrepackCount = pSnap.numChildren() || 0;
            __renderOverviewForDate(fD);
        } catch(e) {
            console.error(e);
        }
    }

    function showMetadata(id) {
        if(!activeBatchData) return;
        const cb = document.getElementById('meta-cancel-banner');
        if(activeBatchData.cancelled_ids && activeBatchData.cancelled_ids[id]) cb.style.display = 'flex'; else cb.style.display = 'none';
        if(activeBatchData.order_details && activeBatchData.order_details[id]) {
            document.getElementById('packing-info-display').style.display = 'block';
            document.getElementById('meta-cust-name').innerText = activeBatchData.order_details[id].name;
            document.getElementById('meta-inv-content').innerText = activeBatchData.order_details[id].content;
        }
    }

    function deleteBatch(id) { if(confirm("Apagar lote?")) db.ref('active_batches/'+id).remove(); }
    function closeModal(id) {
        const el = document.getElementById(id);
        if(el) el.style.display = 'none';
        if(id === 'edit-batch-modal' && __modalBatchRef && __modalBatchCb){
            __modalBatchRef.off('value', __modalBatchCb);
            __modalBatchRef = null;
            __modalBatchCb = null;
        }
    }

    function updatePickingMiniDashboard(all, fD){
        try{
            let batches = 0, ids = 0, products = 0;
            for(let k in all){
                const b = all[k] || {};
                if(b.dateClean !== fD) continue;
                if(b.status !== 'PENDING_PICK') continue;
                batches++;
                const requiredIds = getRequiredBatchIds(b);
                ids += requiredIds.length;
                const inv = b.inventory || {};
                for(let sku in inv){
                    const it = inv[sku] || {};
                    const q = Number(it.q || 0);
                    if(!isNaN(q)) products += q;
                }
            }
            const elB = document.getElementById('pick-card-batches');
            const elI = document.getElementById('pick-card-ids');
            const elP = document.getElementById('pick-card-products');
            if(elB) elB.innerText = batches;
            if(elI) elI.innerText = ids;
            if(elP) elP.innerText = products;
        }catch(e){
            console.error("updatePickingMiniDashboard error", e);
        }
    }

function updateDashboardStats(all, fD, prepackCount) { 
        let nP = 0, nR = 0, nK = 0;
        for(let k in all) {
            let b = all[k];
            if(!b || b.dateClean !== fD) continue;
            const requiredIds = getRequiredBatchIds(b);
            const nI = requiredIds.length;
            const nE = requiredIds.filter(id => (b.processed_ids && b.processed_ids[id])).length;
            nP += nI;
            nK += nE;
            if(b.status === 'READY_TO_PACK') nR += (nI - nE);
        }
        const elP = document.getElementById('card-printed');
        const elR = document.getElementById('card-ready');
        const elK = document.getElementById('card-packed');
        const elPre = document.getElementById('card-prepack');
        if(elP) elP.innerText = nP;
        if(elR) elR.innerText = nR;
        if(elK) elK.innerText = nK;
        if(elPre) elPre.innerText = String(prepackCount || 0);
    }
    function updateSelects(bts, fD) {
        const selWH = document.getElementById('wh-batch-select'), selPK = document.getElementById('pick-batch-select');
        let pkOpt = '<option value="">-- SELECT PICKING BATCH --</option>', whOpt = '<option value="">-- SELECT PACKING BATCH --</option>';
        for(let k in bts) { 
            const b = bts[k]; if(b.dateClean === fD) { 
                const label = b.name + ' | ' + b.carrier; 
                if(b.status === 'PENDING_PICK') pkOpt += `<option value="${k}">${label}</option>`; 
                if(b.status === 'READY_TO_PACK') whOpt += `<option value="${k}">${label}</option>`; 
            } 
        }
        if(selPK) selPK.innerHTML = pkOpt; if(selWH) { selWH.innerHTML = whOpt; const cur = localStorage.getItem('lastPackingBatch'); if(cur && selWH.querySelector(`option[value="${cur}"]`)) selWH.value = cur; }
    }
    function updateMasterPreview() { const tbody = document.querySelector('#master-db-table tbody'), search = document.getElementById('master-search').value.toUpperCase(); tbody.innerHTML = ""; Object.keys(masterProductsDB).forEach(k => { if (k.includes(search) || masterProductsDB[k].toUpperCase().includes(search)) { tbody.innerHTML += `<tr><td>${k}</td><td>${masterProductsDB[k]}</td></tr>`; } }); }
    function handleCSVUpload() { const fileInput = document.getElementById('csv-file-input'); if (!fileInput.files.length) return; const reader = new FileReader(); reader.onload = function(e) { const lines = e.target.result.split(/\r?\n/); const newMaster = {}; lines.forEach((line, index) => { if (index === 0 || !line.trim()) return; const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); if (parts.length >= 2) { let name = parts[0].replace(/^"|"$/g, '').trim(), bar = parts[1].replace(/^"|"$/g, '').trim(); if(bar) newMaster[safeKey(bar)] = name; } }); db.ref('config/master_products').set(newMaster).then(() => alert("Master Updated!")); }; reader.readAsText(fileInput.files[0]); }
    async function createBatch() {
        const n = document.getElementById('off-batch-name').value.trim(),
              c = document.getElementById('off-carrier-select').value,
              tD = document.getElementById('off-batch-date').value;
        if(!n || !tD) return alert("Missing info.");

        const key = safeKey(n + "_" + c);

        let inv = {};
        document.getElementById('off-products-list').value.split('\n').forEach(l => {
            let p = l.split('\t');
            if(p.length>=2) inv[p[0].trim().toUpperCase()] = { q: parseInt(p[1]), pos: p[2] || "??" };
        });

        let det = {};
        let ids = [];
        document.getElementById('off-order-meta').value.split('\n').forEach(l => {
            let p = l.split('\t');
            if(p.length>=1 && p[0].trim()) {
                ids.push(p[0].trim());
                det[p[0].trim()] = { name: p[1]||"N/A", content: p[2]||"N/A" };
            }
        });

        const createdBy = (currentUser && currentUser.email) ? currentUser.email.split('@')[0].toUpperCase() : "SYSTEM";
        const createdDateClean = _nowDateClean();
        const createdTime = _nowTime();
        const createdAt = _dtKey(createdDateClean, createdTime);

        db.ref('active_batches/'+key).set({
            name: n,
            carrier: c,
            expected_ids: ids,
            inventory: inv,
            order_details: det,
            status:'PENDING_PICK',
            dateClean: tD,
            createdBy: createdBy,
            createdAt: createdAt,
            createdDateClean: createdDateClean,
            createdTime: createdTime
        }).then(() => {
            alert("Created!");
            document.getElementById('off-batch-name').value="";
            document.getElementById('off-products-list').value="";
            document.getElementById('off-order-meta').value="";
        });
    }

    // --- PRE-PACKING + RECENT RETURNS (uniform date/time + no locale strings) ---
    function handlePrePack(v) {
        const raw = (v || "").toString().trim();
        if (!raw) return;

        const code = safeKey(raw);
        const dc = _nowDateClean();
        const tm = _nowTime();
        const user = (currentUser && currentUser.email) ? currentUser.email.split('@')[0].toUpperCase() : "UNKNOWN";

        // Try resolve product name from master DB (keep graceful fallbacks)
        const mp = masterProductsDB ? (masterProductsDB[code] || masterProductsDB[raw] || null) : null;
        const prodName = (mp && typeof mp === 'object')
            ? (mp.name || mp.product || mp.title || mp.ref || raw)
            : (typeof mp === 'string' ? mp : raw);

        const payload = {
            code: code,
            product: prodName,
            user: user,
            dateClean: dc,
            time: tm,
            DateTime: _dtKey(dc, tm),
            ts: Date.now()
        };

        db.ref('pre_packing').push(payload).then(() => {
            resetScan && resetScan();
        }).catch(err => {
            console.error(err);
            alert("Erro ao gravar pre-packing.");
        });
    }

    function loadRecentReturns() {
        const tbody = document.querySelector('#recent-returns-table tbody');
        if (!tbody) return;
        const today = _nowDateClean();
        const u = (currentUser && currentUser.email) ? currentUser.email.split('@')[0].toUpperCase() : "UNKNOWN";

        // Avoid duplicate listeners when re-entering tab
        if(__returnsTodayRef && __returnsTodayCb){ __returnsTodayRef.off('value', __returnsTodayCb); }

        // Only THIS USER (mobile-friendly). We filter by dateClean client-side to avoid compound-index needs.
        __returnsTodayRef = db.ref('registos').orderByChild('user').equalTo(u).limitToLast(400);
        __returnsTodayCb = (snap) => {
            const rows = [];
            snap.forEach(ch => {
                const k = ch.key;
                const r = ch.val() || {};
                const mode = (r.mode || r.Type || "").toString().toUpperCase();
                if (mode !== "RETURN" && mode !== "RETURNS") return;

                // Only the selected day (today) on this realtime view
                if ((r.dateClean || "") !== today) return;

                // Extra guard (should be redundant with query)
                if (((r.user || "").toString().toUpperCase()) !== u) return;

                const dc = r.dateClean || "";
                const tm = r.endTime || r.time || "";
                const dt = r.DateTime || _dtKey(dc, tm);
                const ts = r.ts || (dt ? Date.parse(dt.replace(' ', 'T')) : 0) || 0;

                rows.push({ k, tm, user: r.user || "", id: r.id || "", items: r.prods || "", ts, dt });
            });

            rows.sort((a, b) => (a.ts - b.ts) || a.dt.localeCompare(b.dt));

            tbody.innerHTML = rows.map(r => `
<tr>
  <td>${_fmt(r.tm)}</td>
  <td>${_fmt(r.user)}</td>
  <td>${_fmt(r.id)}</td>
  <td>${_fmt(r.items)}</td>
  <td><button class="btn-small btn-delete" onclick="db.ref('registos/${r.k}').remove()">X</button></td>
</tr>`).join('');
        };

        __returnsTodayRef.on('value', __returnsTodayCb);
    }

    function loadPrePackHistory() {
        const tbody = document.querySelector('#prepack-recent-table tbody');
        if (!tbody) return;
        const today = _nowDateClean();
        const u = (currentUser && currentUser.email) ? currentUser.email.split('@')[0].toUpperCase() : "UNKNOWN";

        if(__prepackTodayRef && __prepackTodayCb){ __prepackTodayRef.off('value', __prepackTodayCb); }

        // Only THIS USER (mobile-friendly). We filter by dateClean client-side to avoid compound-index needs.
        __prepackTodayRef = db.ref('pre_packing').orderByChild('user').equalTo(u).limitToLast(400);
        __prepackTodayCb = (snap) => {
            const rows = [];
            snap.forEach(ch => {
                const k = ch.key;
                const p = ch.val() || {};

                // Only the selected day (today) on this realtime view
                if ((p.dateClean || "") !== today) return;

                // Extra guard (should be redundant with query)
                if (((p.user || "").toString().toUpperCase()) !== u) return;

                const tm = p.time || "";
                const dt = p.DateTime || _dtKey(p.dateClean || today, tm);
                const ts = p.ts || (dt ? Date.parse(dt.replace(' ', 'T')) : 0) || 0;

                rows.push({ k, tm, user: p.user || "", product: p.product || p.code || "", ts, dt });
            });

            rows.sort((a, b) => (a.ts - b.ts) || a.dt.localeCompare(b.dt));

            tbody.innerHTML = rows.map(r => `
<tr>
  <td>${_fmt(r.tm)}</td>
  <td>${_fmt(r.user)}</td>
  <td>${_fmt(r.product)}</td>
  <td><button class="btn-small btn-delete" onclick="db.ref('pre_packing/${r.k}').remove()">X</button></td>
</tr>`).join('');
        };

        __prepackTodayRef.on('value', __prepackTodayCb);
    }

    function updateDisplay(m) {
        // Update top labels for PACKING UI
        const idEl = document.getElementById('v-id');
        const trEl = document.getElementById('v-track');

        if (idEl) idEl.textContent = scanData.id || "-";
        if (trEl) trEl.textContent = scanData.track || "-";

        // Render scanned products (always show in v-prods)
        const prodsEl = document.getElementById('v-prods');
        const list = Array.isArray(scanData.prods) ? scanData.prods : [];
        if (prodsEl) {
            prodsEl.innerHTML = "";
            list.forEach(name => {
                prodsEl.innerHTML += `<div class="prod-tag"><span>${_fmt(name)}</span></div>`;
            });
        }

        // IMPORTANT:
        // In PACKING, #meta-inv-content is "EXPECTED CONTENT" (from batch order_details).
        // Do NOT overwrite it with scanned products.
        if ((m || currentMode) !== 'PACKING') {
            // For returns/prepack contexts (if the element exists on screen), show the scanned items list.
            const metaEl = document.getElementById('meta-inv-content');
            if (metaEl) metaEl.textContent = list.length ? list.join(", ") : "-";
        }

        // Returns UI (rv-*)
        const rvId = document.getElementById('rv-id');
        const rvTr = document.getElementById('rv-track');
        const rvProds = document.getElementById('rv-prods');
        if ((m || currentMode) === 'RETURN' || (m || currentMode) === 'RETURNS') {
            if (rvId) rvId.textContent = scanData.id || "-";
            if (rvTr) rvTr.textContent = scanData.track || "-";
            if (rvProds) {
                rvProds.innerHTML = "";
                list.forEach(name => {
                    rvProds.innerHTML += `<div class="prod-tag"><span>${_fmt(name)}</span></div>`;
                });
            }
        }
    }

    (function(){
  const __inp = document.getElementById('main-input');
  if(__inp){
    __inp.addEventListener('keypress', e => {
      if(e.key==='Enter'){
        handleScan(e.target.value.trim());
        e.target.value='';
      }
    });
  }
})();


    // --- FIX: CANCEL BUTTON IN EDIT BATCH MODAL ---
    async function cancelBatchId(batchId, orderId) {
        try {
            const reason = prompt(`Motivo do cancelamento para o ID ${orderId}?`);
            if (!reason || !reason.trim()) return;

            const payload = {
                id: orderId,
                reason: reason.trim(),
                user: (currentUser && currentUser.email ? currentUser.email.split('@')[0].toUpperCase() : "UNKNOWN"),
            dateClean: _nowDateClean(),
            time: _nowTime(),
            DateTime: _nowDateTime(),
            ts: Date.now()
            };

            // Store cancellation info
            await db.ref(`active_batches/${batchId}/cancelled_ids/${orderId}`).set(payload);

            // If it was marked processed, remove to avoid PACKED + CANCELLED inconsistency
            await db.ref(`active_batches/${batchId}/processed_ids/${orderId}`).remove();

            // Log action in batch history
            logBatchAction(batchId, `CANCELLED ID: ${orderId} | Reason: ${payload.reason}`);

            alert(`ID ${orderId} cancelado com sucesso.`);
        } catch (e) {
            console.error(e);
            alert("Erro ao cancelar o ID.");
        }
    }

</script>

<script>
// ===== OPS HARD GUARD (Profile C: OPS locked / Office sees all) =====
(function(){
  var PROFILE = "OPS";
  var ALLOWED = ['sec-picking','sec-prepacking','sec-prepack','sec-returns','sec-warehouse','sec-packing'];

  function isAllowed(id){
    return !!id && ALLOWED.indexOf(String(id)) !== -1;
  }

  function hardRemoveNav(){
    // Remove nav elements that target non-allowed sections
    var navItems = document.querySelectorAll(".nav-item, .nav-btn, .tab-btn, button, a");
    navItems.forEach(function(el){
      var oc = el.getAttribute("onclick") || "";
      var m = oc.match(/\b(tab|switchSection|showSection)\s*\(\s*['"]([^'"]+)['"]/);
      if(m && m[2] && !isAllowed(m[2])){
        el.parentNode && el.parentNode.removeChild(el);
      }
    });
  }

  function hideSections(){
    document.querySelectorAll(".section").forEach(function(sec){
      if(!isAllowed(sec.id)) sec.style.display='none';
    });
  }

  function forceAllowedTab(){
    // ensure only allowed is active
    var active = document.querySelector(".section.active");
    if(active && !isAllowed(active.id)) active.classList.remove("active");
    var ok = document.querySelector(".section.active");
    if(ok && isAllowed(ok.id)) return;

    for(var i=0;i<ALLOWED.length;i++){
      var s = document.getElementById(ALLOWED[i]);
      if(s){
        document.querySelectorAll(".section").forEach(function(x){ x.classList.remove("active"); });
        s.classList.add("active");
        break;
      }
    }
  }

  function lockTabFunction(){
    // Wrap existing tab function to block forbidden
    if(typeof window.tab === 'function' && !window.__tab_wrapped){
      var orig = window.tab;
      window.tab = function(secId, el){
        if(!isAllowed(secId)){
          alert("Sem acesso a esse separador.");
          return;
        }
        return orig(secId, el);
      };
      window.__tab_wrapped = true;
    }
    // Also wrap switchSection/showSection if they exist
    ['switchSection','showSection'].forEach(function(fn){
      if(typeof window[fn] === 'function' && !window['__'+fn+'_wrapped']){
        var orig2 = window[fn];
        window[fn] = function(secId){
          if(!isAllowed(secId)){
            alert("Sem acesso a esse separador.");
            return;
          }
          return orig2.apply(this, arguments);
        };
        window['__'+fn+'_wrapped']=true;
      }
    });
  }

  function setPageBadge(){
    var b=document.getElementById('__app_badge');
    if(b){
      b.textContent = 'OPS PAGE';
      b.style.background = '#0ea5e9';
    }
    var r=document.getElementById('__role_badge');
    if(r){ r.textContent = 'Role: WH'; r.style.background='#1f2937'; }
  }

  function enforce(){
    try{
      setPageBadge();
      hardRemoveNav();
      hideSections();
      lockTabFunction();
      forceAllowedTab();
    }catch(e){ console.error(e); }
  }

  document.addEventListener('DOMContentLoaded', function(){
    enforce();
    setTimeout(enforce, 250);
    setTimeout(enforce, 800);
    setTimeout(enforce, 1800);
  });

  // keep enforcing after login UI flip
  setInterval(function(){
    var main = document.getElementById('main-interface');
    if(main && main.style.display !== 'none'){
      enforce();
    }
  }, 1200);
})();
</script>


<script>
// ===== UI TOP BAR + ERROR OVERLAY (robust auth binding) =====
(function(){
  function ensureErrorOverlay(){
    if(document.getElementById('__err_overlay')) return;
    var d=document.createElement('div');
    d.id='__err_overlay';
    d.style.position='fixed';
    d.style.inset='0';
    d.style.zIndex='999999';
    d.style.background='rgba(0,0,0,0.85)';
    d.style.color='#fff';
    d.style.padding='20px';
    d.style.fontFamily='monospace';
    d.style.overflow='auto';
    d.style.display='none';
    document.body.appendChild(d);
  }
  function showErr(msg){
    try{
      ensureErrorOverlay();
      var d=document.getElementById('__err_overlay');
      d.style.display='block';
      d.innerHTML='<h2 style="margin:0 0 10px 0;">Erro no JavaScript</h2><pre style="white-space:pre-wrap;">'+String(msg)+'</pre>';
    }catch(_){}
  }
  window.__showErr = showErr;
  window.addEventListener('error', function(e){
    showErr((e && e.message ? e.message : 'Erro') + '\n' + (e && e.filename ? e.filename : '') + ':' + (e && e.lineno ? e.lineno : '') );
  });
  window.addEventListener('unhandledrejection', function(e){
    var r = e && e.reason ? e.reason : null;
    var msg = 'Promise rejection: ' + (r && r.code ? (r.code + ' - ' + r.message) : String(r));
    showErr(msg);
  });

  function ensureTopBar(){
    if(document.getElementById('__topbar')) return;
    var bar=document.createElement('div');
    bar.id='__topbar';
    bar.style.position='sticky';
    bar.style.top='0';
    bar.style.zIndex='99999';
    bar.style.background='#0f172a';
    bar.style.color='white';
    bar.style.padding='10px 14px';
    bar.style.display='flex';
    bar.style.alignItems='center';
    bar.style.justifyContent='space-between';
    bar.style.gap='10px';
    bar.style.fontFamily='system-ui, -apple-system, Segoe UI, Roboto, Arial';
    bar.innerHTML = '<div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">'
      + '<span id="__app_badge" style="font-weight:900; padding:6px 10px; border-radius:999px; background:#334155;">APP</span>'
      + '<span id="__user_badge" style="font-weight:800;">User: -</span>'
      + '<span id="__role_badge" style="font-weight:900; padding:6px 10px; border-radius:999px; background:#1f2937;">Role: -</span>'
      + '<span id="__db_badge" style="font-weight:900; padding:6px 10px; border-radius:999px; background:#7c2d12;">DB: ?</span>'
      + '</div>'
      + '<div style="display:flex; gap:10px; align-items:center;">'
      + '<button id="__btn_logout" style="cursor:pointer; border:none; border-radius:10px; padding:8px 12px; font-weight:900; background:#ef4444; color:white;">Logout</button>'
      + '</div>';
    document.body.insertBefore(bar, document.body.firstChild);

    document.getElementById('__btn_logout').onclick=function(){
      try{
        if(window.auth && auth.signOut) return auth.signOut();
        if(window.firebase && firebase.auth) return firebase.auth().signOut();
      }catch(e){
        alert('Logout failed');
      }
    };
  }

  function setBadge(id, txt, bg){
    var el=document.getElementById(id);
    if(!el) return;
    el.textContent = txt;
    if(bg) el.style.background = bg;
  }

  function bindAuthListener(){
    // Try multiple ways to reach auth instance (auth var or firebase.auth())
    var authInst = null;
    try { if (window.auth && auth.onAuthStateChanged) authInst = auth; } catch(_){}
    if(!authInst){
      try { if (window.firebase && firebase.auth) authInst = firebase.auth(); } catch(_){}
    }
    if(!authInst || !authInst.onAuthStateChanged) return false;

    if(window.__topbar_auth_bound) return true;
    window.__topbar_auth_bound = true;

    authInst.onAuthStateChanged(function(u){
      if(u && u.email){
        setBadge('__user_badge', 'User: ' + u.email);
        // infer role by domain if present
        var email = String(u.email).toLowerCase();
        var role = (email.endsWith('@admin.com') ? 'ADMIN' : (email.endsWith('@wh.com') ? 'WH' : 'USER'));
        setBadge('__role_badge', 'Role: ' + role, '#1f2937');
      } else {
        setBadge('__user_badge', 'User: -');
      }
    });
    return true;
  }

  function bindDbListener(){
    if(window.__topbar_db_bound) return;
    var dbInst = null;
    try { if(window.db && db.ref) dbInst = db; } catch(_){}
    if(!dbInst){
      try { if(window.firebase && firebase.database) dbInst = firebase.database(); } catch(_){}
    }
    if(!dbInst || !dbInst.ref) return;

    window.__topbar_db_bound = true;
    try{
      dbInst.ref('.info/connected').on('value', function(snap){
        var ok = !!snap.val();
        setBadge('__db_badge', 'DB: ' + (ok ? 'CONNECTED' : 'OFFLINE'), ok ? '#166534' : '#7c2d12');
      });
    }catch(e){
      setBadge('__db_badge', 'DB: UNKNOWN', '#7c2d12');
    }
  }

  function loopBind(){
    ensureTopBar();
    bindDbListener();
    if(bindAuthListener()) return;
    // keep trying for a few seconds until firebase/auth is initialized
  }

  document.addEventListener('DOMContentLoaded', function(){
    ensureTopBar();
    loopBind();
    var tries=0;
    var t=setInterval(function(){
      tries++;
      loopBind();
      if(window.__topbar_auth_bound && window.__topbar_db_bound) clearInterval(t);
      if(tries>60) clearInterval(t);
    }, 250);
  });
})();
</script>

</body>
</html>
